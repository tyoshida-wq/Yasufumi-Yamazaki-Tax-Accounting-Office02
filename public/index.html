<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>税理士事務所向け AI議事録生成MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body class="min-h-screen bg-slate-50 text-slate-900">
    <header class="border-b border-slate-200 bg-white/80 backdrop-blur">
      <div class="mx-auto flex max-w-5xl flex-col gap-4 px-6 py-8 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-sm font-semibold uppercase tracking-wide text-emerald-600">MVP</p>
          <h1 class="mt-1 text-3xl font-bold tracking-tight">税理士事務所向け AI議事録生成</h1>
          <p class="mt-2 text-sm text-slate-600">
            最長3時間の会議録音を分割し、Gemini 3.0 Flash/Proで文字起こしと議事録化を行うプロトタイプです。
          </p>
        </div>
        <div class="flex items-center gap-3 text-sm text-slate-500">
          <span class="flex items-center gap-2 rounded-full bg-emerald-100 px-3 py-1 font-medium text-emerald-700">
            <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
            ステップ1: 文字起こし
          </span>
          <span class="hidden items-center gap-2 rounded-full bg-indigo-100 px-3 py-1 font-medium text-indigo-700 sm:flex">
            <span class="h-2 w-2 rounded-full bg-indigo-500"></span>
            ステップ2: 議事録生成
          </span>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-5xl space-y-12 px-6 py-10">
      <section class="space-y-6 rounded-3xl border border-slate-200 bg-white/90 p-6 shadow-sm">
        <h2 class="text-xl font-semibold">1. 録音または音声ファイルを準備</h2>
        <div class="grid gap-6 lg:grid-cols-2">
          <div class="space-y-4">
            <h3 class="text-base font-semibold text-slate-700">ブラウザで録音</h3>
            <p class="text-sm text-slate-500">ブラウザのマイクを使用し、会議を直接録音できます。</p>
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div class="flex flex-wrap items-center gap-3">
                <button id="record-start" class="btn-primary">録音開始</button>
                <button id="record-stop" class="btn-muted" disabled>停止</button>
                <span id="record-status" class="text-sm text-slate-500">マイクは未使用です</span>
              </div>
              <div class="mt-3 flex items-center gap-2 text-sm text-slate-600">
                <span class="font-medium">録音時間:</span>
                <span id="record-timer">00:00:00</span>
              </div>
              <div class="mt-4 rounded-lg border border-slate-300 bg-white p-2">
                <canvas id="waveform-canvas" class="w-full" width="800" height="120"></canvas>
              </div>
              <div id="audio-player-container" class="mt-4 hidden rounded-lg border border-emerald-200 bg-emerald-50 p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-emerald-700">録音済み音声</span>
                  <button id="clear-audio" class="text-xs text-emerald-600 hover:text-emerald-800">削除</button>
                </div>
                <audio id="audio-player" controls class="w-full"></audio>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <h3 class="text-base font-semibold text-slate-700">既存ファイルをアップロード</h3>
            <p class="text-sm text-slate-500">WAV / MP3 / M4A / WebMなど一般的な音声形式に対応しています（最大約3時間）。</p>
            <label for="file-input" data-dropzone class="flex cursor-pointer flex-col items-center justify-center gap-3 rounded-2xl border border-dashed border-indigo-300 bg-indigo-50/60 p-6 text-center transition hover:border-indigo-400 hover:bg-indigo-100">
              <input id="file-input" type="file" accept="audio/*" class="hidden" />
              <span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-indigo-500/10 text-indigo-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 16V4m0 12 3.5-3.5M12 16l-3.5-3.5M9 20h6" />
                </svg>
              </span>
              <div>
                <p class="text-base font-medium text-indigo-700">音声ファイルを選択</p>
                <p class="text-xs text-indigo-500">ドラッグ＆ドロップにも対応</p>
              </div>
            </label>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-600" id="file-summary">
              音声ファイルが未選択です。
            </div>
          </div>
        </div>
      </section>

      <section class="space-y-6 rounded-3xl border border-slate-200 bg-white/90 p-6 shadow-sm">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 class="text-xl font-semibold">2. 文字起こしを実行</h2>
            <p class="text-sm text-slate-500">約1MBごとに分割し、5秒ずつ重ねてGemini 3.0 Flash Previewのキューに投入、複数チャンクを並列でタイムスタンプ付き文字起こしします。</p>
          </div>
          <button id="start-processing" class="btn-primary" disabled>文字起こしを開始</button>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="space-y-1 text-sm">
              <p class="font-medium text-slate-700">進捗</p>
              <p id="progress-summary" class="text-slate-500">チャンク送信待ち</p>
            </div>
            <div class="text-right text-sm text-slate-500">
              <p>分割サイズ: <span class="font-medium" id="chunk-info">-</span></p>
              <p>Geminiモデル: <span class="font-medium">Flash Preview (3.0)</span></p>
            </div>
          </div>
          <div class="mt-4 h-2 rounded-full bg-slate-200">
            <div id="progress-bar" class="h-2 rounded-full bg-indigo-500 transition-all" style="width: 0%"></div>
          </div>
          <div class="mt-4 grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            <div>
              <h4 class="font-medium text-sm text-slate-600">ステータス</h4>
              <pre id="status-log" class="log-panel"></pre>
            </div>
            <div>
              <h4 class="font-medium text-sm text-slate-600">最新レスポンス</h4>
              <pre id="response-log" class="log-panel"></pre>
            </div>
            <div>
              <h4 class="font-medium text-sm text-slate-600">サーバーログ</h4>
              <pre id="server-log" class="log-panel">サーバーログはまだありません。</pre>
            </div>
          </div>
          <div class="mt-4 flex flex-wrap gap-3 text-sm" id="queue-actions">
            <button id="trigger-reprocess" class="btn-secondary hidden">未処理チャンクを再処理</button>
            <button id="retry-merge" class="btn-muted hidden">結合を再試行</button>
          </div>
        </div>
      </section>

      <section class="space-y-6 rounded-3xl border border-slate-200 bg-white/90 p-6 shadow-sm">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <div>
            <h2 class="text-xl font-semibold">3. 結果を確認</h2>
            <p class="text-sm text-slate-500">
              タイムスタンプ付き全文を生成後、Gemini 3.0 Pro Previewで議事録を作成します。
            </p>
          </div>
          <div class="flex flex-wrap gap-3">
            <button id="generate-minutes" class="btn-secondary" disabled>議事録を生成</button>
            <button id="download-transcript" class="btn-muted" disabled>全文をダウンロード</button>
            <button id="download-minutes" class="btn-muted" disabled>議事録をダウンロード</button>
          </div>
        </div>

        <div class="grid gap-6 lg:grid-cols-2">
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-base font-semibold text-slate-700">タイムスタンプ付き全文</h3>
              <button id="copy-transcript" class="link-button" disabled>コピー</button>
            </div>
            <pre id="transcript-output" class="result-panel">まだ文字起こしは完了していません。</pre>
          </div>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-base font-semibold text-slate-700">議事録</h3>
              <button id="copy-minutes" class="link-button" disabled>コピー</button>
            </div>
            <pre id="minutes-output" class="result-panel">議事録生成は未実行です。</pre>
          </div>
        </div>
      </section>

      <section class="space-y-6 rounded-3xl border border-slate-200 bg-white/90 p-6 shadow-sm">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 class="text-xl font-semibold">タスク履歴</h2>
            <p class="text-sm text-slate-500">過去の文字起こしタスクの一覧です。タスクをクリックして詳細を確認できます。</p>
          </div>
          <button id="refresh-history" class="btn-secondary">履歴を更新</button>
        </div>

        <div id="task-history-container" class="space-y-3">
          <div class="text-center text-sm text-slate-500 py-8">履歴を読み込んでいます...</div>
        </div>
      </section>

      <section class="rounded-3xl border border-slate-200 bg-white/90 p-6 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-700">利用ガイドと注意事項</h2>
        <ul class="mt-4 space-y-3 text-sm text-slate-600">
          <li>・音声はフロントエンドで約1MBごとに分割し、チャンク間に5秒のオーバーラップを持たせます。</li>
          <li>・サーバーサイドではGemini 3.0 Flash Previewにチャンクをキューイングし、最大4並列でタイムスタンプ付き文字起こしを取得します。</li>
          <li>・全文結合後、必要に応じて「議事録生成」ボタンからGemini 3.0 Pro Previewを呼び出します。</li>
          <li>・Gemini APIキーはCloudflare WorkersのSecretに設定してください。</li>
          <li>・長時間音声の場合はブラウザメモリ使用量が増えるため、十分なスペックの端末をご利用ください。</li>
        </ul>
      </section>
    </main>

    <template id="status-template">
      <div class="rounded-2xl border border-slate-200 bg-white p-4 text-sm"></div>
    </template>

    <script type="module" src="/static/app.js?v=20260202-wait-for-completion"></script>
  </body>
</html>
